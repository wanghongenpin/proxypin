name: Multi-Platform Build

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - windows
          - macos
          - linux
          - android
          - ios
  push:
    tags:
      - 'v*'

env:
  FLUTTER_VERSION: '3.27.2'
  APP_NAME: 'proxypin-with-mcp'

jobs:
  # 提取版本信息
  version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_code: ${{ steps.version.outputs.version_code }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Extract version from pubspec.yaml
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | cut -d'+' -f1)
          VERSION_CODE=$(grep '^version:' pubspec.yaml | sed 's/version: //' | cut -d'+' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "Version: $VERSION, Code: $VERSION_CODE"

  # Windows 构建
  windows:
    needs: version
    if: github.event_name == 'push' || github.event.inputs.platform == 'all' || github.event.inputs.platform == 'windows'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Build Windows
        run: flutter build windows --release
      
      - name: Install flutter_distributor
        run: dart pub global activate flutter_distributor
      
      - name: Build EXE installer
        run: flutter_distributor package --platform windows --targets exe
        continue-on-error: true
      
      - name: Build MSIX
        run: flutter_distributor package --platform windows --targets msix
        continue-on-error: true
      
      - name: Prepare artifacts
        run: |
          mkdir -p artifacts
          if (Test-Path "dist\*\*.exe") { Copy-Item dist\*\*.exe artifacts\${{ env.APP_NAME }}-${{ needs.version.outputs.version }}-windows-setup.exe }
          if (Test-Path "dist\*\*.msix") { Copy-Item dist\*\*.msix artifacts\${{ env.APP_NAME }}-${{ needs.version.outputs.version }}-windows.msix }
          if (!(Test-Path "artifacts\*.exe") -and !(Test-Path "artifacts\*.msix")) {
            Compress-Archive -Path build\windows\x64\runner\Release\* -DestinationPath artifacts\${{ env.APP_NAME }}-${{ needs.version.outputs.version }}-windows.zip
          }
        shell: pwsh
      
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: artifacts/*

  # macOS 构建
  macos:
    needs: version
    if: github.event_name == 'push' || github.event.inputs.platform == 'all' || github.event.inputs.platform == 'macos'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        run: |
          flutter pub get
          cd macos && pod install
      
      - name: Build macOS
        run: flutter build macos --release
      
      - name: Install create-dmg
        run: brew install create-dmg
      
      - name: Create DMG
        run: |
          create-dmg \
            --volname "ProxyPin" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "ProxyPin.app" 200 190 \
            --hide-extension "ProxyPin.app" \
            --app-drop-link 600 185 \
            "${{ env.APP_NAME }}-${{ needs.version.outputs.version }}-macos.dmg" \
            "build/macos/Build/Products/Release/ProxyPin.app"
        continue-on-error: true
      
      - name: Fallback to zip if DMG fails
        run: |
          cd build/macos/Build/Products/Release
          zip -r ${{ env.APP_NAME }}-${{ needs.version.outputs.version }}-macos.zip ProxyPin.app
          mv ${{ env.APP_NAME }}-${{ needs.version.outputs.version }}-macos.zip ../../../../../
      
      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: |
            *.dmg
            *.zip

  # Linux 构建
  linux:
    needs: version
    if: github.event_name == 'push' || github.event.inputs.platform == 'all' || github.event.inputs.platform == 'linux'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build libgtk-3-dev libblkid-dev liblzma-dev
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Build Linux
        run: flutter build linux --release
      
      - name: Create DEB package
        run: |
          VERSION=${{ needs.version.outputs.version }}
          cd build/linux/x64/release
          rm -rf package
          mkdir -p package/DEBIAN
          cat > package/DEBIAN/control << EOF
          Package: proxypin
          Version: $VERSION
          Priority: optional
          Architecture: amd64
          Depends: ca-certificates
          Section: utils
          Maintainer: wanghongenpin@gmail.com
          Homepage: https://github.com/wanghongenpin/proxypin
          Description: Open source free HTTP(S) traffic capture tool
          EOF
          mkdir -p package/usr/share/applications
          cp ../../../../linux/proxy-pin.desktop package/usr/share/applications/
          mkdir -p package/opt
          cp -r bundle package/opt/proxypin
          dpkg-deb --build package ${{ env.APP_NAME }}-$VERSION-linux.deb
      
      - name: Create tarball
        run: |
          VERSION=${{ needs.version.outputs.version }}
          cd build/linux/x64/release
          tar -czvf ${{ env.APP_NAME }}-$VERSION-linux.tar.gz bundle
      
      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: |
            build/linux/x64/release/*.deb
            build/linux/x64/release/*.tar.gz

  # Android 构建
  android:
    needs: version
    if: github.event_name == 'push' || github.event.inputs.platform == 'all' || github.event.inputs.platform == 'android'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Build APK
        run: flutter build apk --release
      
      - name: Build App Bundle
        run: flutter build appbundle --release
        continue-on-error: true
      
      - name: Rename artifacts
        run: |
          VERSION=${{ needs.version.outputs.version }}
          mkdir -p artifacts
          cp build/app/outputs/flutter-apk/app-release.apk artifacts/${{ env.APP_NAME }}-$VERSION-android.apk
          if [ -f build/app/outputs/bundle/release/app-release.aab ]; then
            cp build/app/outputs/bundle/release/app-release.aab artifacts/${{ env.APP_NAME }}-$VERSION-android.aab
          fi
      
      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: artifacts/*

  # iOS 构建
  ios:
    needs: version
    if: github.event_name == 'push' || github.event.inputs.platform == 'all' || github.event.inputs.platform == 'ios'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        run: |
          flutter pub get
          cd ios && pod install
      
      - name: Build iOS (no codesign)
        run: flutter build ios --release --no-codesign
      
      - name: Create IPA
        run: |
          VERSION=${{ needs.version.outputs.version }}
          cd build/ios/iphoneos
          mkdir -p Payload
          cp -r Runner.app Payload/
          zip -r ../../../${{ env.APP_NAME }}-$VERSION-ios.ipa Payload
      
      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-artifacts
          path: "*.ipa"

  # 发布到 GitHub Releases
  release:
    needs: [version, windows, macos, linux, android, ios]
    if: always() && github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true
      
      - name: List artifacts
        run: ls -la artifacts/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: proxypin-with-mcp v${{ needs.version.outputs.version }}
          draft: false
          prerelease: false
          files: artifacts/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
